<h1>Import Preview</h1>

<div class="summary-card">
  <h2>Summary</h2>
  <ul>
    <li><strong>Total rows:</strong> <%= @summary[:total_rows] %></li>
    <li><strong>Properties:</strong> <%= @summary[:by_record_type]["property"] || 0 %></li>
    <li><strong>Units:</strong> <%= @summary[:by_record_type]["unit"] || 0 %></li>
    <li><strong>Verified rows:</strong> <%= @summary[:verified_rows] %></li>
    <li><strong>Rejected rows:</strong> <%= @summary[:rejected_rows] %></li>
    <li><strong>New properties:</strong> <%= @summary[:new_properties] %></li>
    <li><strong>Properties already in database:</strong> <%= @summary[:existing_properties] || 0 %></li>
  </ul>
</div>

<% if @summary[:rejected_rows] > 0 %>
  <div class="error-card">
    <h2 class="error-title">⚠ Validation Errors Found</h2>
    <p>Please fix these issues in your spreadsheet and upload again:</p>
    <table class="data-table">
      <thead>
        <tr class="table-header">
          <th class="table-cell">Row</th>
          <th class="table-cell">Type</th>
          <th class="table-cell">Building Name</th>
          <th class="table-cell">Unit</th>
          <th class="table-cell">Street Address</th>
          <th class="table-cell">City</th>
          <th class="table-cell">State</th>
          <th class="table-cell">Zip</th>
          <th class="table-cell">Errors</th>
        </tr>
      </thead>
      <tbody>
        <% @import.property_import_rows.rejected.sort_by { |row| row.original_row_number || Float::INFINITY }.each do |row| %>
          <tr>
            <td class="table-cell text-center font-bold">
              <%= row.original_row_number || "N/A" %>
            </td>
            <td class="table-cell">
              <%= row.record_type == "property" ? "Property" : "Unit" %>
            </td>
            <td class="table-cell"><%= row.building_name %></td>
            <td class="table-cell"><%= row.unit_number || "—" %></td>
            <td class="table-cell"><%= row.street_address %></td>
            <td class="table-cell"><%= row.city %></td>
            <td class="table-cell"><%= row.state %></td>
            <td class="table-cell"><%= row.zip_code %></td>
            <td class="table-cell error-text">
              <ul class="error-list">
                <% row.error_list.each do |error| %>
                  <li><%= error %></li>
                <% end %>
              </ul>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<div class="preview">
  <%# Separate properties into new and existing %>
  <% new_properties = @import.property_rows.verified.where(existing_property_id: nil) %>
  <% existing_properties = @import.property_rows.verified.where.not(existing_property_id: nil) %>

  <%# New Properties Section - only show if there are new properties %>
  <% if new_properties.any? %>
    <h2>New Properties to Create</h2>
    <table class="data-table mb-30">
      <thead>
        <tr class="table-header-success">
          <th class="table-cell">Building Name</th>
          <th class="table-cell">Type</th>
          <th class="table-cell">Street Address</th>
          <th class="table-cell">City</th>
          <th class="table-cell">State</th>
          <th class="table-cell">Zip</th>
          <th class="table-cell">Units to Import</th>
        </tr>
      </thead>
      <tbody>
        <% new_properties.each do |row| %>
          <% new_unit_count = @import.unit_rows
                .verified
                .where("parsed_data->>'building_name' = ?", row.building_name)
                .count %>
          <% property_type = new_unit_count > 1 ? "Multi-Family" : "Single-Family" %>
          <tr>
            <td class="table-cell"><%= row.building_name %></td>
            <td class="table-cell"><%= property_type %></td>
            <td class="table-cell"><%= row.street_address %></td>
            <td class="table-cell"><%= row.city %></td>
            <td class="table-cell"><%= row.state %></td>
            <td class="table-cell"><%= row.zip_code %></td>
            <td class="table-cell text-center font-bold success-text">
              <%= property_type == "Multi-Family" ? new_unit_count : '--' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Existing Properties Section - only show if there are existing properties with new units %>
  <% existing_with_units = existing_properties.select do |row| 
       @import.unit_rows.verified.where("parsed_data->>'building_name' = ?", row.building_name).exists?
     end %>

  <% if existing_with_units.any? %>
    <h2>Existing Properties (will receive new units)</h2>
    <table class="data-table mb-30">
      <thead>
        <tr class="table-header-success">
          <th class="table-cell">Building Name</th>
          <th class="table-cell">Street Address</th>
          <th class="table-cell">City</th>
          <th class="table-cell">State</th>
          <th class="table-cell">Zip</th>
          <th class="table-cell">New Units</th>
          <th class="table-cell">Total Units</th>
        </tr>
      </thead>
      <tbody>
        <% existing_with_units.each do |row| %>
          <% new_unit_count = @import.unit_rows
                .verified
                .where("parsed_data->>'building_name' = ?", row.building_name)
                .count %>
          <% existing_unit_count = row.existing_property.units.count %>
          <% total_unit_count = existing_unit_count + new_unit_count %>
          <% property_type = total_unit_count > 1 ? "Multi-Family" : "Single-Family" %>
          <tr>
            <td class="table-cell"><%= row.building_name %> (<%= property_type %>)</td>
            <td class="table-cell"><%= row.street_address %></td>
            <td class="table-cell"><%= row.city %></td>
            <td class="table-cell"><%= row.state %></td>
            <td class="table-cell"><%= row.zip_code %></td>
            <td class="table-cell text-center font-bold success-text">
              <%= new_unit_count %>
            </td>
            <td class="table-cell text-center">
              <%= total_unit_count %>
              <span class="unit-count-note">(<%= existing_unit_count %> existing)</span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Units section - only show if there are verified units %>
  <% verified_units = @import.unit_rows.verified %>
  <% if verified_units.any? %>
    <h2 class="mt-30">Units to Import</h2>
    <table class="data-table">
      <thead>
        <tr class="table-header-success">
          <th class="table-cell">Building Name</th>
          <th class="table-cell">Unit Number</th>
        </tr>
      </thead>
      <tbody>
        <% verified_units.order(:id).each do |row| %>
          <tr>
            <td class="table-cell"><%= row.building_name %></td>
            <td class="table-cell"><%= verified_units.count > 0 ? row.unit_number : '--' %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Already Existing Section - properties already in DB with no new units %>
  <% existing_without_units = existing_properties.select do |row| 
       !@import.unit_rows.verified.where("parsed_data->>'building_name' = ?", row.building_name).exists?
     end %>

  <% if existing_without_units.any? %>
    <h2>Properties Already in Database (no changes)</h2>
    <table class="data-table mb-30">
      <thead>
        <tr class="table-header">
          <th class="table-cell">Building Name</th>
          <th class="table-cell">Street Address</th>
          <th class="table-cell">City</th>
          <th class="table-cell">State</th>
          <th class="table-cell">Zip</th>
          <th class="table-cell">Existing Units</th>
        </tr>
      </thead>
      <tbody>
        <% existing_without_units.each do |row| %>
          <% existing_unit_count = row.existing_property.units.count %>
          <% property_type = existing_unit_count > 1 ? "Multi-Family" : "Single-Family" %>
          <tr>
            <td class="table-cell"><%= row.building_name %> (<%= property_type %>)</td>
            <td class="table-cell"><%= row.street_address %></td>
            <td class="table-cell"><%= row.city %></td>
            <td class="table-cell"><%= row.state %></td>
            <td class="table-cell"><%= row.zip_code %></td>
            <td class="table-cell text-center">
              <%= property_type == "Multi-Family" ? existing_unit_count : '--' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Show a message if nothing will be imported %>
  <% if new_properties.empty? && existing_with_units.empty? && verified_units.empty? %>
    <div class="warning-card">
      <h3 class="warning-title">No Changes to Import</h3>
      <p>No new properties will be created and no new units will be added.</p>
      <% if existing_without_units.any? %>
        <p><%= existing_without_units.count %> property(s) already exist in the database with matching data.</p>
      <% end %>
      <p class="mb-0">Please upload a different file if you intended to add new data.</p>
    </div>
  <% end %>
</div>

<div class="action-bar">
  <% if @summary[:verified_rows] > 0 && @summary[:rejected_rows] == 0 && (new_properties.any? || existing_with_units.any?) %>
    <%= button_to "✓ Confirm and Import #{@summary[:verified_rows]} rows", 
                  execute_property_import_path(@import), 
                  method: :post,
                  class: "btn btn-success btn-large" %>
  <% elsif @summary[:rejected_rows] > 0 %>
    <p class="error-message">Please fix validation errors before importing.</p>
  <% end %>
  <p style="margin-top: 10px;"><%= link_to "← Cancel and return to upload", new_property_import_path %></p>
</div>