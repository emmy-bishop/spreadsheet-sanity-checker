<h1>Import Preview</h1>

<div class="summary" style="background: #f5f5f5; padding: 10px; margin-bottom: 20px;">
  <h2>Summary</h2>
  <ul>
    <li><strong>Total rows:</strong> <%= @summary[:total_rows] %></li>
    <li><strong>Properties:</strong> <%= @summary[:by_record_type][:property] || 0 %></li>
    <li><strong>Units:</strong> <%= @summary[:by_record_type][:unit] || 0 %></li>
    <li><strong>Verified rows:</strong> <%= @summary[:verified_rows] %></li>
    <li><strong>Rejected rows:</strong> <%= @summary[:rejected_rows] %></li>
    <li><strong>New properties:</strong> <%= @summary[:new_properties] %></li>
    <li><strong>Existing properties:</strong> <%= @summary[:existing_properties] %></li>
  </ul>
</div>

<% if @summary[:rejected_rows] > 0 %>
  <div class="errors" style="background: #ffeeee; padding: 20px; margin-bottom: 20px; border: 1px solid #ff0000;">
    <h2 style="color: red;">⚠ Validation Errors Found</h2>
    <p>Please fix these issues in your spreadsheet and upload again:</p>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f0f0;">
          <th style="padding: 10px; border: 1px solid #ccc;">Row</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Type</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Building Name</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Unit</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Street Address</th>
          <th style="padding: 10px; border: 1px solid #ccc;">City</th>
          <th style="padding: 10px; border: 1px solid #ccc;">State</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Zip</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Errors</th>
        </tr>
      </thead>
      <tbody>
        <% @import.property_import_rows.rejected.sort_by { |row| row.original_row_number || Float::INFINITY }.each do |row| %>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc; text-align: center; font-weight: bold;">
              <%= row.original_row_number || "N/A" %>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc;">
              <%= row.record_type == "property" ? "Property" : "Unit" %>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.building_name %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.unit_number || "—" %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.street_address %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.city %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.state %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.zip_code %></td>
            <td style="padding: 10px; border: 1px solid #ccc; color: red;">
              <ul style="margin: 0; padding-left: 20px;">
                <% row.error_list.each do |error| %>
                  <li><%= error %></li>
                <% end %>
              </ul>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<div class="preview">
  <%# Filter properties to only show those that will actually change %>
  <% properties_to_show = @import.property_rows.verified.order(:id).select do |row| %>
    <%# Keep if:
       1. It's a new property (will be created), OR
       2. It's an existing property that has at least one valid unit to import
    %>
    <% row.existing_property.blank? || 
       @import.unit_rows.verified.where("parsed_data->>'building_name' = ?", row.building_name).exists? %>
  <% end %>
  <%# Only show the Properties section if there are properties to show %>
  <% if properties_to_show.any? %>
    <h2>Properties to Import</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f0f0;">
          <th style="padding: 10px; border: 1px solid #ccc;">Status</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Building Name</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Type</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Street Address</th>
          <th style="padding: 10px; border: 1px solid #ccc;">City</th>
          <th style="padding: 10px; border: 1px solid #ccc;">State</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Zip</th>
          <th style="padding: 10px; border: 1px solid #ccc;">New Units</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Total Units</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Action</th>
        </tr>
      </thead>
      <tbody>
        <% properties_to_show.each do |row| %>
          <% is_existing = row.existing_property.present? %>
          <% new_unit_count = @import.unit_rows
                .verified
                .where("parsed_data->>'building_name' = ?", row.building_name)
                .count %>
          <%# Calculate total units (DB + new import) %>
          <% existing_unit_count = is_existing ? row.existing_property.units.count : 0 %>
          <% total_unit_count = existing_unit_count + new_unit_count %>
          <%# Determine property type based on TOTAL units after import %>
          <% property_type = total_unit_count > 0 ? "Multi-Family" : "Single-Family" %>
          <tr style="<%= 'background: #ffeeee;' if row.rejected? %>">
            <td style="padding: 10px; border: 1px solid #ccc;">
              <%= is_existing ? "Existing" : row.status.titleize %>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.building_name %></td>
            <td style="padding: 10px; border: 1px solid #ccc;">
              <span>
                <%= property_type %>
              </span>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.street_address %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.city %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.state %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.zip_code %></td>
            <td style="padding: 10px; border: 1px solid #ccc; text-align: center; font-weight: bold; color: #4CAF50;">
              <%= new_unit_count > 0 ? new_unit_count : "--" %>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
              <%= total_unit_count > 0 ? total_unit_count : "--" %>
              <% if existing_unit_count > 0 %>
                <span style="font-size: 0.85em; color: #666;">(<%= existing_unit_count %> existing)</span>
              <% end %>
            </td>
            <td style="padding: 10px; border: 1px solid #ccc;">
              <strong>
                <% if is_existing %>
                  <span style="color: #2196F3;">Will update unit data</span>
                <% else %>
                  <span style="color: #4CAF50;">Will be created</span>
                <% end %>
              </strong>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Units section - only show if there are verified units %>
  <% verified_units = @import.unit_rows.verified %>
  <% if verified_units.any? %>
    <h2 style="margin-top: 30px;">Units to Import</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f0f0;">
          <th style="padding: 10px; border: 1px solid #ccc;">Status</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Building Name</th>
          <th style="padding: 10px; border: 1px solid #ccc;">Unit Number</th>
        </tr>
      </thead>
      <tbody>
        <% verified_units.order(:id).each do |row| %>
          <tr>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.status.titleize %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.building_name %></td>
            <td style="padding: 10px; border: 1px solid #ccc;"><%= row.unit_number %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <%# Show a message if nothing will be imported %>
  <% if properties_to_show.empty? && verified_units.empty? %>
    <div style="background: #fff3cd; padding: 20px; margin-top: 20px; border: 1px solid #ffc107; border-radius: 4px;">
      <h3 style="color: #856404; margin-top: 0;">✕ No Changes to Import</h3>
      <p>No new properties will be created and no valid units were found to import.</p>
      <p style="margin-bottom: 0;">Please check for validation errors above or upload a different file.</p>
    </div>
  <% end %>
</div>
<div style="margin-top: 30px;">
  <% if @summary[:verified_rows] > 0 && @summary[:rejected_rows] == 0 && @summary[:new_properties] > 0 %>
    <%= button_to "✓ Confirm and Import #{@summary[:verified_rows]} rows", 
                  execute_property_import_path(@import), 
                  method: :post,
                  style: "background: #4CAF50; color: white; padding: 15px 32px; font-size: 16px; border: none; cursor: pointer;"%>
  <% elsif @summary[:rejected_rows] > 0 %>
    <p style="color: red; font-weight: bold;">Please fix validation errors before importing.</p>
  <% end %>
  <%= link_to "← Cancel and return to upload", new_property_import_path, style: "margin-left: 20px;" %>
</div>